name: Flutter Test Drive

on: [push, pull_request]

jobs:
  accessibility_test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: "stable"
      - run: "flutter pub get"
      - name: "Run Flutter Accessibility Tests"
        run: "flutter test test/accessibility_test.dart"

  drive_ios:
    strategy:
      matrix:
        device:
          - "iPhone 8 (14.4)"
          - "iPhone 11 Pro Max (14.4)"
      fail-fast: false
    runs-on: macos-latest
    steps:
      - name: "List all simulators"
        run: "xcrun instruments -s"
      - name: "Start Simulator"
        run: |
          UDID=$(
            xcrun instruments -s |
            awk \
              -F ' *[][]' \
              -v 'device=${{ matrix.device }}' \
              '$1 == device { print $2 }'
          )
          xcrun simctl boot "${UDID:?No Simulator with this name found}"
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: "stable"
      - name: "Run Flutter Driver tests"
        run: "flutter drive --target=test_driver/driver.dart"

  drive_android:
    runs-on: macos-latest
    strategy:
      matrix:
        api-level: [21, 29]
        target: [default]
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: "stable"
      - name: "Run Flutter Driver tests"
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: ${{ matrix.target }}
          arch: x86_64
          profile: Nexus 6
          script: "flutter drive --target=test_driver/driver.dart"

  web_build_and_deploy:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3.3.1
      - uses: subosito/flutter-action@v2
        with:
          channel: "stable"
      - name: "Web Build ?"
        run: |
          flutter pub get
          flutter build web
      - name: "Web Deploy ?"
        uses: JamesIves/github-pages-deploy-action@4.0.0
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          branch: gh-pages
          folder: build/web
